<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="LiWuK0jxrq55oR5-aNOK6r0wFuUC8EvSlpNYhiiBkDk">
  <meta name="baidu-site-verification" content="code-MRwc3a52M3">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhengjun.top","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="On going…  .&#x2F;primecoind -gen -debug -frontport&#x3D;6667 -host&#x3D;121.43.185.81 -feeaddr&#x3D;AVjsWxuvcmjDvULpuegjKbgjrCthi2JVeq -daemon Primecoin XPM Pool Serverhttps:&#x2F;&#x2F;github.com&#x2F;madMAx43v3r&#x2F;xpmpoolPrimecoin XPM">
<meta property="og:type" content="article">
<meta property="og:title" content="primecoin-pool学习">
<meta property="og:url" content="http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="郑君的学习笔记">
<meta property="og:description" content="On going…  .&#x2F;primecoind -gen -debug -frontport&#x3D;6667 -host&#x3D;121.43.185.81 -feeaddr&#x3D;AVjsWxuvcmjDvULpuegjKbgjrCthi2JVeq -daemon Primecoin XPM Pool Serverhttps:&#x2F;&#x2F;github.com&#x2F;madMAx43v3r&#x2F;xpmpoolPrimecoin XPM">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/b477a26f.png">
<meta property="article:published_time" content="2018-08-14T06:38:11.000Z">
<meta property="article:modified_time" content="2018-11-01T03:32:32.000Z">
<meta property="article:author" content="郑  君">
<meta property="article:tag" content="blockchain">
<meta property="article:tag" content="primecoin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/b477a26f.png">


<link rel="canonical" href="http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/","path":"2018/08/14/学习笔记/区块链/primecoin/primecoin-pool学习/","title":"primecoin-pool学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>primecoin-pool学习 | 郑君的学习笔记</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="郑君的学习笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">郑君的学习笔记</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">要比昨天进步一点点</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">215</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">80</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">1286</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%B9%E7%8E%87%E7%AD%89%E7%9B%B8%E5%85%B3%E8%AE%A1%E7%AE%97"><span class="nav-number">1.</span> <span class="nav-text">费率等相关计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%96%E7%9F%BF%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.</span> <span class="nav-text">挖矿协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getwork-2012%E5%B9%B4%E6%9C%AB-%E5%BA%9F%E5%BC%83"><span class="nav-number">2.1.</span> <span class="nav-text">getwork 2012年末 废弃</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Getblocktemplate"><span class="nav-number">2.2.</span> <span class="nav-text">Getblocktemplate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stratum-mining-protocol-STM"><span class="nav-number">2.3.</span> <span class="nav-text">Stratum mining protocol (STM)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Methods-client-to-server"><span class="nav-number">2.3.1.</span> <span class="nav-text">Methods (client to server)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mining-authorize"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">mining.authorize</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Methods-server-to-client"><span class="nav-number">2.3.2.</span> <span class="nav-text">Methods (server to client)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetBlockTemplate-GBT"><span class="nav-number">2.4.</span> <span class="nav-text">GetBlockTemplate(GBT)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%BF%E6%B1%A0%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">矿池类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%98%E7%AE%A1%E7%9F%BF%E6%B1%A0"><span class="nav-number">3.1.</span> <span class="nav-text">托管矿池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#P2Pool-%E7%9F%BF%E6%B1%A0"><span class="nav-number">3.2.</span> <span class="nav-text">P2Pool 矿池</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="郑  君"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">郑  君</p>
  <div class="site-description" itemprop="description">C++，golang，Java，Python，Kotlin，区块链，全栈</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">1286</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">215</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ZhengHanYunBlog" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ZhengHanYunBlog" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhenghanyun2021@126.com" title="E-Mail → mailto:zhenghanyun2021@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCmh8TlSil0IrCA-AQ9Xx9_Q" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCmh8TlSil0IrCA-AQ9Xx9_Q" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhengjun.top/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="郑  君">
      <meta itemprop="description" content="C++，golang，Java，Python，Kotlin，区块链，全栈">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="郑君的学习笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          primecoin-pool学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-14 14:38:11" itemprop="dateCreated datePublished" datetime="2018-08-14T14:38:11+08:00">2018-08-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2018-11-01 11:32:32" itemprop="dateModified" datetime="2018-11-01T11:32:32+08:00">2018-11-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>On going…</p>
<p> ./primecoind -gen -debug -frontport=6667 -host=121.43.185.81 -feeaddr=AVjsWxuvcmjDvULpuegjKbgjrCthi2JVeq -daemon</p>
<p>Primecoin XPM Pool Server<br><a target="_blank" rel="noopener" href="https://github.com/madMAx43v3r/xpmpool">https://github.com/madMAx43v3r/xpmpool</a><br>Primecoin XPM GPU Miner for xpmpool (aka. madPrimeMiner)<br><a target="_blank" rel="noopener" href="https://github.com/madMAx43v3r/xpmclient">https://github.com/madMAx43v3r/xpmclient</a><br>The solo-mining server code is at: <a target="_blank" rel="noopener" href="https://github.com/madMAx43v3r/xpmserver">https://github.com/madMAx43v3r/xpmserver</a></p>
<p>Primecoin XPM GPU Miner for xpmpool (aka. madPrimeMiner)<br><a target="_blank" rel="noopener" href="https://github.com/eXtremal-ik7/xpmclient">https://github.com/eXtremal-ik7/xpmclient</a></p>
<p><a target="_blank" rel="noopener" href="http://xpmforall.org/">http://xpmforall.org/</a></p>
<span id="more"></span>

<p>挖矿有两种方式，一种叫SOLO挖矿，另一种是去矿池挖矿。</p>
<p>目前最广泛使用的挖矿协议 Stratum</p>
<p>数据库相关操作<br>pool.h</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dbo::backend::Postgres* mBackend;</span><br><span class="line">dbo::Session* mSession;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">createTables</span><br><span class="line">// 增加一条记录</span><br><span class="line">session.add</span><br></pre></td></tr></table></figure>

<p>Pools are groups of cooperating miners who agree to share block rewards in proportion to their contributed mining power.<br>By joining a mining pool you share your hash rate with the pool. Once the pool finds a block you get a payout based on the percent of hash rate contributed to the pool.</p>
<p>If you contributed 1% of the pools hashrate, you’d get .125 bitcoins out of the current 12.5 bitcoin block reward.</p>
<p>Mining pools coordinate many hundreds or thousands of miners, over specialized pool-mining protocols.</p>
<p>Successful blocks pay the reward to a pool bitcoin address, rather than individual miners.<br>The pool server will periodically make payments to the miners’ bitcoin addresses,<br>once their share of the rewards has reached a certain threshold.</p>
<p>Typically, the pool server charges a percentage fee of the rewards for providing the pool-mining service.</p>
<p>Miners participating in a pool split the work of searching for a solution to a candidate block,<br>earning “shares” for their mining contribution.</p>
<p>The mining pool sets a higher target (lower difficulty) for earning a share, typically more than 1,000 times easier<br>than the bitcoin network’s target. When someone in the pool successfully mines a<br>block, the reward is earned by the pool and then shared with all miners in proportion<br>to the number of shares they contributed to the effort.</p>
<p>How does a mining pool measure the individual contributions, so as to fairly<br>distribute the rewards, without the possibility of cheating?</p>
<p>The answer is to use bitcoin’s Proof-of-Work algorithm to measure each pool miner’s contribution, but set at<br>a lower difficulty so that even the smallest pool miners win a share frequently enough<br>to make it worthwhile to contribute to the pool.</p>
<p>By setting a lower difficulty for earning shares, the pool measures the amount of work done by each miner.<br>Each time a pool miner finds a block header hash that is less than the pool target, she proves she<br>has done the hashing work to find that result. More importantly, the work to find shares contributes,<br>in a statistically measurable way, to the overall effort to find a hash lower than the bitcoin network’s target.<br>Thousands of miners trying to find low-value hashes will eventually find one low enough to satisfy the bitcoin network target.</p>
<p>用抛骰子游戏来说明挖矿：<br>假设当前的网络难度是抛出 4 以下的数字，那么矿池会把矿池难度设置为 8 以下的数字，难度比网络难度低，矿工每次抛出 8 以下的数字就完成一次工作，赚到 shares<br>当许多矿工都在抛的时候，就有几率抛出小于 4 的情况，这样整个矿池就获得奖励，然后按照每个矿工的 share 数值分利润。</p>
<h2 id="费率等相关计算"><a href="#费率等相关计算" class="headerlink" title="费率等相关计算"></a>费率等相关计算</h2><p> In all these schemes $ B $ stands for a block reward minus pool fee and $ p $ is a probability of finding a block in a share attempt<br> ($ p=\frac{1}{D} $, where $ D $ is current block difficulty)</p>
<p>Pay-per-Share<br>The Pay-per-Share (PPS) approach offers an instant, guaranteed payout to a miner for his contribution to the probability that the pool finds a block.</p>
<p>Each share costs exactly the expected value of each hash attempt $ R= B × p $</p>
<p>Proportional<br>Miners earn shares until the pool finds a block (the end of the mining round). After that each user gets reward $ R=B × \frac{n}{N} $, where $ n $ is amount of his own shares, and $ N $ is amount of all shares in this round. In other words, all shares are equal, but its cost is calculated only in the end of a round.</p>
<p>Based on the accepted shares, members get rewarded using different methods, which include the following:</p>
<ul>
<li>Pay-per share (PPS): Allows instant payout solely based on accepted shares contributed by the pool member, who are allowed to withdraw their earnings instantly from the pool’s existing balance.</li>
<li>Proportional (PROP): At the end of a mining round, a reward which is proportional to the number of the member’s shares with respect to total shares in the pool, is offered.</li>
<li>Shared Maximum Pay Per Share (SMPPS): A method similar to PPS but limits the payout to the maximum that the pool has earned.</li>
<li>Equalized Shared Maximum Pay Per Share (ESMPPS): A method similar to SMPPS, but distributes payments equally among all miners in the bitcoin mining pool.</li>
</ul>
<p>Other variations include Double Geometric Method (DGM), Recent Shared Maximum Pay Per Share (RSMPPS), Capped Pay Per Share with Recent Backpay (CPPSRB), and Bitcoin Pooled Mining (BPM).</p>
<h2 id="挖矿协议"><a href="#挖矿协议" class="headerlink" title="挖矿协议"></a>挖矿协议</h2><p>Pool miners connect to the pool server using a mining protocol such as Stratum (STM) or GetBlockTemplate (GBT).</p>
<p>Both the STM and GBT protocols create block templates<br>that contain a template of a candidate block header. The pool server constructs a can‐<br>didate block by aggregating transactions, adding a coinbase transaction (with extra<br>nonce space), calculating the merkle  root, and linking to the previous block hash. The<br>header of the candidate block is then sent to each of the pool miners as a template.<br>Each pool miner then mines using the block template, at a higher (easier) target than<br>the bitcoin network target, and sends any successful results back to the pool server to<br>earn shares.</p>
<h3 id="getwork-2012年末-废弃"><a href="#getwork-2012年末-废弃" class="headerlink" title="getwork 2012年末 废弃"></a>getwork 2012年末 废弃</h3><p>rpc response</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;result&quot;: &#123;</span><br><span class="line">    &quot;hash1&quot;: &quot;00000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000010000&quot;,</span><br><span class="line">    &quot;data&quot;: &quot;00000001c570c4764aadb3f09895619f549000b8b51a789e7f58ea750000709700000000103ca064f8c76c390683f8203043e91466a7fcc40e6ebc428fbcc2d89b574a864db8345b1b00b5ac00000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080020000&quot;,</span><br><span class="line">    &quot;midstate&quot;: &quot;e772fc6964e7b06d8f855a6166353e48b2562de4ad037abc889294cea8ed1070&quot;,</span><br><span class="line">    &quot;target&quot;: &quot;ffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000&quot;</span><br><span class="line">    &#125;,</span><br><span class="line"> &quot;error&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>data大小为128字节，块头(Block Head)大小是80字节，那为何是128字节呢？那就得回到SHA256算法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000001  // uint32, 块版本</span><br><span class="line">c570c4764aadb3f09895619f549000b8b51a789e7f58ea750000709700000000  // uint256, 前向块Hash</span><br><span class="line">103ca064f8c76c390683f8203043e91466a7fcc40e6ebc428fbcc2d89b574a86  // uint256, merkle root hash</span><br><span class="line">4db8345b  // uint32, time</span><br><span class="line">1b00b5ac  // uint32, bits</span><br><span class="line">00000000  // uint32, nonce</span><br><span class="line">00000080  // uint32, 补零的首个uint32，大小头翻转后二进制：10000000 00000000 00000000 00000000</span><br><span class="line">000000000000000000000000000000000000000000000000000000000000000000  // 补零padding</span><br><span class="line">000000000000000000000000000000000000000000000000000000000000000000  // 补零padding</span><br><span class="line">0000000080020000  // uint64，翻转后即： 0x00000280 -&gt; 640 表示数据区640bits(80Bytes)</span><br></pre></td></tr></table></figure>

<p>计算 POW 只需要 block header 的 76 个字节就可以了，到 bits 这个位置。然后 nonce 从0开始累加计算 hash 值。<br>有的情况在 nonce 累加到最大值之后仍然不会小于目标值，这个时候需要一个 extraNonce 字段。然后 nonce 设为 0，通过累加 extraNonce 计算 hash 值</p>
<p>Example getwork data: 00000001a10bacc7e639d1c69a01014bc5db6f2604b3477a3f273a4e019a232700000000a5942372cc60477c8a276e59c8f1a3f58654ea2f6c4402bf1b18e48455b5b8f64f10868b1c07475200000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000080020000</p>
<p>The data field I got was:</p>
<p>00000001 - version<br>a10bacc7e639d1c69a01014bc5db6f2604b3477a3f273a4e019a232700000000 - prev_block<br>a5942372cc60477c8a276e59c8f1a3f58654ea2f6c4402bf1b18e48455b5b8f6 - merkle_root<br>4f10868b - timestamp<br>1c074752 - bits<br>00000000 - nonce<br>00 - txn_count of 0 Number of transaction entries, this value is always 0<br>0000800000000000000000000000000000000000000000000000000000000000000000000000000000000080020000 - ??</p>
<p>A solo miner increments Nonce until it overflows. Then it increments extraNonce and resets Nonce. extraNonce is located in the coinbase transaction, so changing it alters the Merkle root. extraNonce is reset based on the time.</p>
<p>For many potential blocks, there is no value of the nonce that will give a hash less than the target.  When that happens, the node must alter something in the block header and try again.  The timestamp is a good candidate, since it usually takes some time to try all 2^32 nonces.  New transactions may have come in across the network that can be added to the tree too.</p>
<p>there was also a nonce in the Merkle tree calculations, It is in the generation transaction, which changes the Merkle hash.</p>
<p>In a pool, the pool server will hand out unique headers to each worker/request, by using the extraNonce and rehashing the tree, to prevent duplication of work and get better odds of finding a valid block.</p>
<p>The extranonce can be found in the coinbase data from a coinbase transaction.<br>This data can be interpreted as a script pushing data onto the stack and the extranonce is the second value.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">    &quot;vin&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;coinbase&quot; : &quot;03443b0403858402062f503253482f&quot;,</span><br><span class="line">            &quot;sequence&quot; : 4294967295</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>can be interpreted as:<br>03 = push 3 bytes onto the stack<br>443b04 = 3 bytes pushed onto the stack &lt;– Block index<br>03 = push 3 bytes onto the stack<br>858402 = 3 bytes pushed onto the stack &lt;– The extranonce<br>06 = push 6 bytes onto the stack<br>2f503253482f = 6 bytes pushed onto the stack &lt;– arbitrary data</p>
<p>EDIT: This format was defined by BIP34 and applies to blocks with version &gt;= 2. I’m not sure how the extranonce was managed before that.<br>My guess is that the extranonce is 8 bytes max but is stored with a compressed representation for lower values.<br>It seems to confirm the script structure with the extranonce being the second value pushed onto the stack. I was puzzled by the first value but it may be the same value as the bits fields stored in the header.</p>
<p>矿机出现之后，挖矿速度得到极大提高，当前比特币矿机算力已经达到10T/秒级别。而getwork只给外部挖矿程序提供32字节共4G的搜索空间，如果继续使用getwork协议，矿机需要频繁调用RPC接口，这显然不可行。如今BTC和LTC节点都已经禁用getwork协议，转向更新更高效的getblocktemplate协议。</p>
<p>区块大小序列化后 &lt;= 1MB，否则认为非法。</p>
<h3 id="Getblocktemplate"><a href="#Getblocktemplate" class="headerlink" title="Getblocktemplate"></a>Getblocktemplate</h3><p>you can change the extraNonce field<br>getblocktemplate协议诞生于2012年中叶，此时矿池已经出现。矿池采用getblocktemplate协议与节点客户端交互，采用stratum协议与矿工交互，这是最典型的矿池搭建模式。</p>
<img alt="b477a26f.png" src="/2018/08/14/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/primecoin/primecoin-pool%E5%AD%A6%E4%B9%A0/b477a26f.png" width height>

<h3 id="Stratum-mining-protocol-STM"><a href="#Stratum-mining-protocol-STM" class="headerlink" title="Stratum mining protocol (STM)"></a>Stratum mining protocol (STM)</h3><p><a target="_blank" rel="noopener" href="http://stratumprotocol.org/">官网</a> 端口 3333<br>用来替代 getwork 协议<br>为什么要用 STM？</p>
<ol>
<li>HTTP，需要矿工驱动通讯，效率不高</li>
<li>Ntime Rolling，无法满足更快的矿工的任务需求：当前协议只能修改 ntime 和 nonce。</li>
<li>Long Polling，一个反向的模式</li>
</ol>
<h4 id="Methods-client-to-server"><a href="#Methods-client-to-server" class="headerlink" title="Methods (client to server)"></a>Methods (client to server)</h4><h5 id="mining-authorize"><a href="#mining-authorize" class="headerlink" title="mining.authorize"></a>mining.authorize</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mining.authorize(&quot;username&quot;, &quot;password&quot;)</span><br><span class="line">return true (successful), or false,</span><br></pre></td></tr></table></figure>

<h4 id="Methods-server-to-client"><a href="#Methods-server-to-client" class="headerlink" title="Methods (server to client)"></a>Methods (server to client)</h4><p>…</p>
<h3 id="GetBlockTemplate-GBT"><a href="#GetBlockTemplate-GBT" class="headerlink" title="GetBlockTemplate(GBT)"></a>GetBlockTemplate(GBT)</h3><p>getblocktemplate协议诞生于2012年中叶，此时矿池已经出现。矿池采用getblocktemplate协议与节点客户端交互，采用stratum协议与矿工交互，这是最典型的矿池搭建模式。</p>
<h2 id="矿池类型"><a href="#矿池类型" class="headerlink" title="矿池类型"></a>矿池类型</h2><p>目前比特币矿池主要分为两种类型：托管矿池和P2P矿池</p>
<h3 id="托管矿池"><a href="#托管矿池" class="headerlink" title="托管矿池"></a>托管矿池</h3><h3 id="P2Pool-矿池"><a href="#P2Pool-矿池" class="headerlink" title="P2Pool 矿池"></a>P2Pool 矿池</h3><p>P2Pool是一个点对点的矿池，没有中心管理人。</p>
<p>比特币核心开发人员Matt Corallo发布了比特币改善提案（Bitcoin Improvement Proposal）的草案，旨在通过采用新的挖矿协议进一步实现比特币挖矿的去中心化。<br>BetterHash挖矿协议</p>
<p>P2Pool works by decentralizing the functions of the pool server, implementing a parallel blockchain-like system called a share chain.</p>
<p>矿池通过专用挖矿协议协调成百上千的矿工。个人矿工在建立矿池账号后，设置他们的矿机连接到矿池服务器。他们的挖矿设备在挖矿时保持和矿池服务器的连接，和其他矿工同步各自的工作。这样，矿池中的矿工分享挖矿任务，之后分享奖励。</p>
<p>成功出块的奖励支付到矿池的比特币地址，而不是单个矿工的。一旦奖励达到一个特定的阈值，矿池服务器便会定期支付奖励到矿工的比特币地址。通常情况下，矿池服务器会为提供矿池服务收取一个百分比的费用。</p>
<p>参加矿池的矿工把搜寻候选区块的工作量分割，并根据他们挖矿的贡献赚取“份额”。矿池为赚取“份额”设置了一个低难度的目标，通常比比特币网络难度低1000倍以上。当矿池中有人成功挖出一块，矿池获得奖励，并和所有矿工按照他们做出贡献的“份额”数的比例分配。</p>
<p>矿池的核心工作是给矿工分配任务，统计工作量并分发收益。矿池将区块难度分成很多难度更小的任务下发给矿工计算，矿工完成一个任务后将工作量提交给矿池，叫提交一个share。假如全网区块难度要求Hash运算结果的前70个比特位都是0，那么矿池给矿工分配的任务可能只要求前30位是0（根据矿工算力调节），矿工完成指定难度任务后上交share，矿池再检测在满足前30位为0的基础上，看看是否碰巧前70位都是0。</p>
<p>矿池如何衡量每个人的贡献，既能公平分配奖励，又避免作弊的可能？答案是在设置一个较低难度的前提下，使用比特币的工作量证明算法来衡量每个矿工的贡献。<br>因此，即使是池中最小的矿工也经常能分得奖励，这足以激励他们为矿池做出贡献。通过设置一个较低的取得份额的难度，矿池可以计量出每个矿工完成的工作量。每当矿工发现一个小于矿池难度的区块头hash，就证明了它已经完成了寻找结果所需的hash计算。更重要的是，这些为取得份额贡献而做的工作，能以一个统计学上可衡量的方法，整体寻找一个比特币网络的目标散列值。成千上万的矿工尝试较小区间的hash值，最终可以找到符合比特币网络要求的结果。</p>
<p>矿池会根据每个矿工的算力情况分配不同难度的任务，矿池是如何判断矿工算力大小以分配合适的任务难度呢？调节思路和比特币区块难度一样，矿池需要借助矿工的share率，矿池希望给每个矿工分配的任务都足够让矿工运算一定时间，比如说1秒，如果矿工在一秒之内完成了几次任务，说明矿池当前给到的难度低了，需要调高，反之。如此下来，经过一段时间调节，矿池能给矿工分配合理难度，并计算出矿工的算力。</p>
<p>矿工连接到矿池服务器使得一个采矿协议⽐如Stratum(STM)或者GetBlockTemplate(GBT)。STM和GBT协议都创建包含候选区块头模板的区块模板。矿池服务器通过聚集交易，添加coinbase交易（和额外的随机值空间），计算MERKLE根，并连接到上一个块hash来建立一个候选区块。这个候选区块的头部作为模板分发给每个矿工。矿工用这个区块模板在低于比特币网络的难度下采矿，并发送成功的结果返回矿池服务器赚取份额。</p>
<p>矿池通过getblocktemplate协议与网络节点交互，以获得区块链的最新信息，通过stratum协议与矿工交互。此外，为了让之前用getwork协议挖矿的软件也可以连接到矿池挖矿，矿池一般也支持getwork协议，通过阶层挖矿代理机制实现（Stratum mining proxy）。须知在矿池刚出现时，显卡挖矿还是主力，getwork用起来非常方便，另外早期的FPGA矿机有些是用getwork实现的，stratum与矿池采用TCP方式通信，数据使用JSON封装格式</p>
<p>getblocktemplate遗留下来的几个问题：<br>矿工驱动：在getblocktemplate协议里，依然是由矿工主动通过HTTP方式调用RPC接口向节点申请挖矿数据，这就意味着，网络最新区块的变动无法及时告知矿工，造成算力损失。</p>
<p>数据负载：如上所述，如今正常的一次getblocktemplate调用节点都会反馈回1.5M左右的数据，其中主要数据是交易列表，矿工与矿池需频繁交互数据，显然不能每次分配工作都要给矿工附带那么多信息。再者巨大的内存需求将大大影响矿机性能，增加成本。</p>
<p>Stratum协议彻底解决了以上问题：<br>Stratum协议采用主动分配任务的方式，也就是说，矿池任何时候都可以给矿工指派新任务，对于矿工来说，如果收到矿池指派的新任务，应立即无条件转向新任务；矿工也可以主动跟矿池申请新任务。</p>
<p>现在最核心的问题是如何让矿工获得更大的搜索空间，如果参照getwork协议，仅仅给矿工可以改变nNonce和nTime字段，则交互的数据量很少，但这点搜索空间肯定是不够的。想增加搜索空间，只能在hashMerkleroot下功夫，如果让矿工自己构造coinbase，那么搜索空间的问题将迎刃而解，但代价是必要要把区块包含的所有交易都交给矿工，矿工才能构造交易列表的Merkleroot，这对于矿工来说压力更大，对于矿池带宽要求也更高。</p>
<p>Stratum协议巧妙解决了这个问题，成功实现既可以给矿工增加足够的搜索空间，又只需要交互很少的数据量，这也是Stratum协议最具创新的地方。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee, if you like!</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="郑  君 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="郑  君 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/blockchain/" rel="tag"># blockchain</a>
              <a href="/tags/primecoin/" rel="tag"># primecoin</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/08/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/linux/ubuntu/ubuntu14-04-%E5%AE%89%E8%A3%85mingw/" rel="prev" title="ubuntu14.04-安装mingw">
                  <i class="fa fa-chevron-left"></i> ubuntu14.04-安装mingw
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/08/16/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE/bitcoin/bitcoin-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" rel="next" title="bitcoin-常见问题">
                  bitcoin-常见问题 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备18010120号-1 </a>
      <img src="/images/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt=""><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011202010521" rel="noopener" target="_blank">沪公安备案31011202010521号 </a>
  </div>

<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">郑  君</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">2.1m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">31:20</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/code-unfold.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
